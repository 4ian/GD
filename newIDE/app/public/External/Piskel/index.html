<html>
<head>
  <title>Gdevelop Piskel Editor</title>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
   <span id="label">Status: null </span>
  <script>
  const electron = require('electron');
  const ipcRenderer = electron.ipcRenderer ;
  const path = require('path');
  const fs = require('fs');
  const async = require('async');
 
  function base64_encode(file) {
      // read binary data
      var bitmap = fs.readFileSync(file);
      // console.log("64STRING::  "+bitmap.toString('base64'));
      return "data:image/png;base64," + bitmap.toString('base64');
  }

  ipcRenderer.on('piskelAnimation',(event,piskelData) => {
    var editorFrameEl = document.querySelector(".editor-frame");
    var pskl = editorFrameEl.contentWindow.pskl;
    let label = document.getElementById("label");
    label.innerHTML = 'errrrrrrrr ' 
    if (pskl) {
    var imageFrames = piskelData.imageFrames;
    label.innerHTML = "count "+ String(imageFrames.length);
    var imageData = []; 
    var piskelXsize = -1;
    var piskelYsize = -1;
    async.each(imageFrames, function(imagePath, callback) {
        var image64 = new Image();
        image64.onload = function () {
          imageData.push(image64);  
          if (image64.width > piskelXsize)
          {
            piskelXsize = image64.width ;
          };
          if (image64.height > piskelYsize)
          {
            piskelYsize = image64.height ;
          };
          callback();
        }
        // This is the important part! Set src, otherwise the `onload` will not fire
        image64.src = base64_encode(imagePath);
    }, function(err) {
        var piskelFile = pskl.service.ImportService.prototype.createPiskelFromImages_(imageData, piskelData.name, piskelXsize, piskelYsize, false);
        console.log(pskl.app.piskelController);
        pskl.app.piskelController.setPiskel(piskelFile,{});
        pskl.app.piskelController.setFPS(piskelData.fps);
    });
    }
  });
  </script>
  <iframe class="editor-frame" src="editor/index.html"></iframe>
  <script type="text/javascript" src="script.js"></script>
  
</body>
</html>