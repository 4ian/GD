<html>
<head>
  <title>Gdevelop Piskel Editor</title>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
   <div align="right" style="background-color:black">
    <span id="label">Status: null </span>
    <button id="cancelBut" onclick="cancelChanges()" style="margin-right: 10px;margin-top: 5px;">
      Cancel Changes
    </button>
    <button id="saveBut" onclick="SaveToGD()" style="margin-right: 10px;margin-top: 5px;">
      Save Back To Gdevelop
    </button>
   </div>
  <script>
  const electron = require('electron');
  const ipcRenderer = electron.ipcRenderer ;
  const path = require('path');
  const fs = require('fs');
  const async = require('async');
  const remote = electron.remote;
 
  // document.addEventListener("onhide", function (e) {
  //   SaveToGD();
  //   var window = remote.getCurrentWindow();
  //   window.close();
  // }); 

  function fileExists(path) {
  try  {
    return fs.statSync(path).isFile();
  }
  catch (e) { 
    if (e.code == 'ENOENT') { // no such file or directory. File really does not exist
      return false;
    }
    console.log("Exception fs.statSync (" + path + "): " + e);
    throw e; // something else went wrong, we don't have rights, ...
    }
  }

  function makeFileNameUnique(path) /// returns a path where a file doesnt already exist. Use to avoid unwanted file overwriting
  {
      if (!fileExists(path)) {
        console.log("OK-doesnt exist: "+path);
        return path
      };
      var folderPath = path.substring(0,path.lastIndexOf("/")+1);
      var fileFormat = path.substring(path.lastIndexOf("."),path.length);
      var oldFileName = path.substring(path.lastIndexOf("/")+1,path.lastIndexOf("."));
      var appendNumber = 0;
      var newUniqueNamePath = folderPath + oldFileName + "-" + String(appendNumber) + fileFormat;
      while (fileExists(newUniqueNamePath))
      { 
        console.log("Try "+newUniqueNamePath);
        appendNumber += 1;
        newUniqueNamePath = folderPath + oldFileName + "-" + String(appendNumber) + fileFormat;
      }
      return newUniqueNamePath
  }

  function base64_encode(file) { // read binary data
      var bitmap = fs.readFileSync(file);
      return "data:image/png;base64," + bitmap.toString('base64');
  }

  function downloadAsFile (content, filename, filePath) { /// download individual frame to path
  var reader = new FileReader()
  reader.onload = function(){
    var buffer = new Buffer(reader.result)
    fs.writeFile(filePath, buffer, {}, (err, res) => {
      if(err){
        console.error(err)
        return
      }
      console.log('file saved')
    })
  }
  reader.readAsArrayBuffer(content)
  }

  function SaveToGD() { ///Determine paths to avoid any unwanted/unpredictable results
    var editorFrameEl = document.querySelector(".editor-frame");
    var pskl = editorFrameEl.contentWindow.pskl;
    var layer = pskl.app.piskelController.getCurrentLayer();
    var piskelFramePaths = [];
    for (i = 0; i < pskl.app.piskelController.getFrameCount(); i++) {
      var exportPath = layer.getFrameAt(i).originalPath    
      if (exportPath == null) { //if frame was made in piskel, come up with a unique path, so as not to overwrite any existing files
        exportPath = this.guessedExportPath + '-PSKL-' + (i + 1) + '.png';
        exportPath = makeFileNameUnique(exportPath);
        console.log("new undefined path:"+exportPath);
      }
      else
      { //if it came from gdevelop- overwrite the original file that it came from
        if (piskelFramePaths.includes(exportPath)) // Prevent overwriting frames that were created via duplication of imported frames
        {
          console.log("Do not overwrite:"+exportPath);
          exportPath = makeFileNameUnique(exportPath);
        }
        else
        {
          console.log("Overwriting file:"+exportPath);
        } 
      };
      //finally render and save
      var canvas = pskl.app.piskelController.renderFrameAt(i, true);
      pskl.utils.BlobUtils.canvasToBlob(canvas, function(blob) {
        downloadAsFile(blob, exportPath, exportPath);
        piskelFramePaths.push(exportPath);
      });
    }
    //finally reload the frames in gdevelop and close the window
    ipcRenderer.send("piskelSavedChanges",piskelFramePaths);
    remote.getCurrentWindow().close();
  }

  function cancelChanges()
  {
    remote.getCurrentWindow().close();
  }

  var guessedExportPath
  ipcRenderer.on('piskelAnimation',(event,piskelData) => {
    this.guessedExportPath = null;
    var editorFrameEl = document.querySelector(".editor-frame");
    var pskl = editorFrameEl.contentWindow.pskl;
    let label = document.getElementById("label");
    label.innerHTML = piskelData['name'];
    if (pskl) {
    var imageFrames = piskelData.imageFrames;
    var imageData = []; 
    var piskelXsize = -1;
    var piskelYsize = -1;
    async.each(imageFrames, function(imagePath, callback) {
        var image64 = new Image();
        image64.onload = function () {
          imageData.push(image64);  
          if (image64.width > piskelXsize)
          {
            piskelXsize = image64.width ;
          };
          if (image64.height > piskelYsize)
          {
            piskelYsize = image64.height ;
          };
          callback();
        }
        // This is the important part! Set src, otherwise the `onload` will not fire
        image64.src = base64_encode(imagePath);
        if (this.guessedExportPath == null)//need this to guess new filenames later
        {
          this.guessedExportPath = imagePath.substring(0,imagePath.lastIndexOf("/")+1) + piskelData.name;
        };
    }, function(err) {
        /// Finally load the image objects into piskel
        var piskelFile = pskl.service.ImportService.prototype.createPiskelFromImages_(imageData, piskelData.name, piskelXsize, piskelYsize, false);
        pskl.app.piskelController.setPiskel(piskelFile,{});
        pskl.app.piskelController.setFPS(piskelData.fps);

        //// add original path variable to frame objects, so we can overwrite original frame files
        var layer = pskl.app.piskelController.getCurrentLayer();
        for (i = 0; i < pskl.app.piskelController.getFrameCount(); i++) {
          layer.getFrameAt(i).originalPath = imageFrames[i] ;
          console.log(layer.getFrameAt(i));
        };
    });
    }
  });
  </script>
  <iframe class="editor-frame" src="editor/index.html"></iframe>
  <script type="text/javascript" src="script.js"></script>
  
</body>
</html>